<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Mapa de Ado칞칚o de Animais</title>
 먝
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.css" />
 먝
  <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/9.23.0/firebase-app-compat.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/9.23.0/firebase-firestore-compat.min.js"></script>
 먝
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
   먝
    body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #f0f2f5; min-height: 100vh; display: flex; flex-direction: column; }
   먝
    .header { background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); color: white; padding: 20px; text-align: center; box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
    .header h1 { font-size: 2rem; margin-bottom: 5px; }
    .header p { font-size: 1rem; opacity: 0.9; }
   먝
    .container { display: flex; flex-grow: 1; }
   먝
    #map { flex-grow: 1; height: 100vh; min-height: 600px; }
   먝
    .sidebar { background: white; width: 350px; padding: 20px; box-shadow: -4px 0 8px rgba(0,0,0,0.1); overflow-y: auto; }
    .sidebar h2 { margin-bottom: 20px; color: #333; }
   먝
    .sensor-info { margin-bottom: 20px; padding: 15px; border-radius: 8px; background: #f8f9fa; border: 1px solid #e9ecef; }
    .sensor-info .sensor { display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 0.9rem; }
    .sensor-info .sensor strong { color: #555; }
   먝
    .toggle-btn { background: #6c757d; color: white; border: none; padding: 10px; border-radius: 5px; width: 100%; cursor: pointer; margin-bottom: 20px; }
    .toggle-btn:hover { background: #5a6268; }
   먝
    #adoptionFormSection { display: none; }
   먝
    .form-group { margin-bottom: 15px; }
    .form-group label { display: block; margin-bottom: 5px; font-weight: 600; color: #333; }
    .form-group input, .form-group textarea { width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px; }
   먝
    .submit-btn { background: #28a745; color: white; border: none; padding: 10px; border-radius: 5px; width: 100%; cursor: pointer; }
    .submit-btn:hover { background: #218838; }

    .compass-arrow { display: inline-block; transform-origin: center; font-size: 24px; transition: transform 0.2s; }
    .leaflet-div-icon { background: transparent; border: none; }
  </style>
</head>
<body>
  <div class="header">
    <h1>游 Mapa de Ado칞칚o de Animais</h1>
    <p>Encontre animais para ado칞칚o perto de voc칡 ou cadastre um novo ponto.</p>
  </div>
 먝
  <div class="container">
    <div id="map"></div>
   먝
    <div class="sidebar">
      <button id="toggleViewBtn" class="toggle-btn">Cadastrar Novo Ponto de Ado칞칚o</button>
     먝
      <div id="sensorInfoSection">
        <h2>Informa칞칫es do seu dispositivo</h2>
        <div class="sensor-info">
          <div class="sensor"><span>游늸 Localiza칞칚o:</span> <strong id="location">Aguardando...</strong></div>
          <div class="sensor"><span>游빐 B칰ssola:</span> <strong id="compass">Aguardando...</strong> <span class="compass-arrow" id="arrow">拘勇</span></div>
          <div class="sensor"><span>游늻 Aceler칪metro:</span> <strong id="motion">Aguardando...</strong></div>
          <div class="sensor"><span>游눠 Luz ambiente:</span> <strong id="light">Aguardando...</strong></div>
        </div>
      </div>
     먝
      <div id="adoptionFormSection">
        <h2>Cadastrar Novo Ponto de Ado칞칚o</h2>
        <form id="adoptionForm">
          <div class="form-group">
            <label for="ongName">Nome da ONG:</label>
            <input type="text" id="ongName" required>
          </div>
          <div class="form-group">
            <label for="animalName">Nome do Animal:</label>
            <input type="text" id="animalName" required>
          </div>
          <div class="form-group">
            <label for="animalInfo">Info. do Animal:</label>
            <textarea id="animalInfo" placeholder="Ra칞a, idade, temperamento..."></textarea>
          </div>
          <div class="form-group">
            <label for="eventDate">Data do Evento:</label>
            <input type="date" id="eventDate" required>
          </div>
          <div class="form-group">
            <label for="eventTime">Hora do Evento:</label>
            <input type="time" id="eventTime" required>
          </div>
          <div class="form-group">
            <label>游늸 Localiza칞칚o do Ponto:</label>
            <input type="number" id="adoptionLat" placeholder="Latitude" readonly required>
            <input type="number" id="adoptionLon" placeholder="Longitude" readonly required>
          </div>
          <button type="submit" class="submit-btn">Salvar Ponto de Ado칞칚o</button>
          <div id="formStatus" style="margin-top: 10px;"></div>
        </form>
      </div>
    </div>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/9.23.0/firebase-app-compat.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/9.23.0/firebase-firestore-compat.min.js"></script>
 먝
  <script>
    let db;
    let map;
    let userMarker;
    let adoptionMarkers = [];

    // ==== CRIA칂츾O IMEDIATA DO MAPA ====
    map = L.map('map').setView([-23.5505, -46.6333], 10);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);

    // ==== L칩gica de inicializa칞칚o da aplica칞칚o (ASYNC) ====
    async function initializeApp() {
      try {
                // CORRE칂츾O: Buscando a configura칞칚o da Serverless Function (Vercel)
        const response = await fetch('/api/firebaseConfig');
        const firebaseConfig = await response.json();
                
                // Verifica se a configura칞칚o foi carregada corretamente
                if (!firebaseConfig.projectId) {
                    throw new Error("Configura칞칚o do Firebase n칚o carregada. Verifique o arquivo /api/firebaseConfig.js e as Vari치veis de Ambiente no Vercel.");
                }

        firebase.initializeApp(firebaseConfig);
        db = firebase.firestore();
        console.log('Firebase e Firestore inicializados com sucesso!');

        initSensorsAndLocation(); 
        loadAdoptionLocations(); 
      } catch (error) {
        console.error('Erro na inicializa칞칚o da aplica칞칚o:', error);
        alert('Erro ao carregar a aplica칞칚o. Verifique a Fun칞칚o Serverless e as Vari치veis de Ambiente.');
      }
    }

    // ==== L칩gica de mapa e sensores ====
    function initSensorsAndLocation() {
     먝
      // Marcador de localiza칞칚o do usu치rio
      const userIcon = L.divIcon({ html: "游늸", className: "user-icon leaflet-div-icon", iconSize: [24, 24], iconAnchor: [12, 12] });
      userMarker = L.marker([0, 0], { icon: userIcon }).addTo(map);

      if (navigator.geolocation) {
        navigator.geolocation.watchPosition(
          position => {
            const { latitude, longitude } = position.coords;
            userMarker.setLatLng([latitude, longitude]);
            document.getElementById("location").textContent = `Lat: ${latitude.toFixed(5)}, Lon: ${longitude.toFixed(5)}`;
          },
          error => {
            document.getElementById("location").textContent = `Erro: ${error.message}`;
          },
          { enableHighAccuracy: true }
        );
      } else {
        document.getElementById("location").textContent = "Geolocaliza칞칚o n칚o suportada.";
      }

      // L칩gica para b칰ssola, aceler칪metro e sensor de luz
      if (window.DeviceOrientationEvent) {
        window.addEventListener("deviceorientation", function(event) {
          if (event.absolute || event.webkitCompassHeading !== undefined) {
            const heading = event.webkitCompassHeading || 360 - event.alpha;
            document.getElementById("compass").textContent = heading.toFixed(2) + "춿";
            document.getElementById("arrow").style.transform = `rotate(${heading}deg)`;
          }
        }, true);
      } else { document.getElementById("compass").textContent = "N칚o suportado."; }

      if (window.DeviceMotionEvent) {
        window.addEventListener("devicemotion", function(event) {
          const { x, y, z } = event.acceleration || { x: 0, y: 0, z: 0 };
          document.getElementById("motion").textContent = `X: ${x.toFixed(2)}, Y: ${y.toFixed(2)}, Z: ${z.toFixed(2)}`;
        });
      } else { document.getElementById("motion").textContent = "N칚o suportado."; }
            
      // L칩gica do Sensor de Luz
      if ('AmbientLightSensor' in window) {
        try {
          const sensor = new AmbientLightSensor();
          sensor.addEventListener('reading', () => { document.getElementById("light").textContent = sensor.illuminance + " lux"; });
          sensor.start();
        } catch (err) { document.getElementById("light").textContent = `Erro: ${err.message}`; }
      } else { document.getElementById("light").textContent = "N칚o suportado."; }
    }

    // ==== L칩gica de persist칡ncia e formul치rio ====
    async function loadAdoptionLocations() {
      try {
        const snapshot = await db.collection('adoptionLocations').get();
        snapshot.forEach(doc => {
          const data = doc.data();
          if (data.localizacao && data.localizacao.latitude && data.localizacao.longitude) {
            addAdoptionMarker(data);
          }
        });
        console.log('Pontos de ado칞칚o carregados com sucesso!');
      } catch (error) {
        console.error('Erro ao carregar pontos de ado칞칚o:', error);
      }
    }
   먝
    function addAdoptionMarker(data) {
      const lat = data.localizacao.latitude;
      const lon = data.localizacao.longitude;
      const popupContent = `
        <b>${data.nome_ong}</b><br>
        Animal: ${data.animal_nome}<br>
        Info: ${data.animal_info || 'N/A'}<br>
        Data: ${data.data_evento}<br>
        Hora: ${data.horario_evento}
      `;
            // CORRE칂츾O: Adicionando 'leaflet-div-icon' para garantir que o marcador de pata n칚o tenha fundo branco.
      const adoptionIcon = L.divIcon({ html: "游", className: "adoption-icon leaflet-div-icon", iconSize: [24, 24], iconAnchor: [12, 12] });
      const newMarker = L.marker([lat, lon], { icon: adoptionIcon }).addTo(map).bindPopup(popupContent);
      adoptionMarkers.push(newMarker);
    }

    document.getElementById('adoptionForm').addEventListener('submit', async function(e) {
      e.preventDefault();
      const formStatus = document.getElementById('formStatus');
      const data = {
        nome_ong: document.getElementById('ongName').value,
        animal_nome: document.getElementById('animalName').value,
        animal_info: document.getElementById('animalInfo').value,
        data_evento: document.getElementById('eventDate').value,
        horario_evento: document.getElementById('eventTime').value,
        localizacao: {
          latitude: parseFloat(document.getElementById('adoptionLat').value),
          longitude: parseFloat(document.getElementById('adoptionLon').value)
        },
        timestamp: firebase.firestore.FieldValue.serverTimestamp()
      };
      try {
        await db.collection('adoptionLocations').add(data);
        formStatus.textContent = 'Ponto de ado칞칚o salvo com sucesso!';
        formStatus.style.color = 'green';
        document.getElementById('adoptionForm').reset();
        addAdoptionMarker(data); 
      } catch (error) {
        console.error('Erro ao salvar ponto de ado칞칚o:', error);
        formStatus.textContent = 'Erro ao salvar. Verifique as regras do Firebase.';
        formStatus.style.color = 'red';
      }
    });
   먝
    // Adiciona um listener para atualizar as coordenadas no formul치rio
    map.on('click', function(e) {
      const { lat, lng } = e.latlng;
      document.getElementById('adoptionLat').value = lat.toFixed(6);
      document.getElementById('adoptionLon').value = lng.toFixed(6);
    });

    // ==== L칩gica de interface e bot칫es ====
    document.getElementById('toggleViewBtn').addEventListener('click', function() {
      const formSection = document.getElementById('adoptionFormSection');
      const sensorSection = document.getElementById('sensorInfoSection');
      const button = document.getElementById('toggleViewBtn');
      if (formSection.style.display === 'none') {
        formSection.style.display = 'block';
        sensorSection.style.display = 'none';
        button.textContent = 'Ver Minha Localiza칞칚o e Sensores';
      } else {
        formSection.style.display = 'none';
        sensorSection.style.display = 'block';
        button.textContent = 'Cadastrar Novo Ponto de Ado칞칚o';
      }
    });
   먝
    // Chama a fun칞칚o principal de inicializa칞칚o
    initializeApp();
  </script>
</body>
</html>
